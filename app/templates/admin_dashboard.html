{% extends "base.html" %}
{% block title %}Admin Dashboard{% endblock %}
{% block content %}
<div class="menu-container" style="max-width: 700px; width: 100%;">
    <div class="menu-card">
        <h1 class="menu-title">Admin Dashboard</h1>
        <p class="menu-subtitle">View seating chart, sales summary, and manage reservations</p>
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="dashboard-section" style="margin-top: -20px; margin-bottom: 20px;">
            {% for category, message in messages %}
                <p style="color:#22c55e; text-align:center;">{{ message }}</p>
            {% endfor %}
            </div>
        {% endif %}
        {% endwith %}
        <div class="dashboard-section">
            <h2 style="font-size: 1.8rem;">Total Sales Collected: <span style="color: #34d399;">${{ "%.2f"|format(total_sales) }}</span></h2>
        </div>
        <div class="dashboard-section" style="overflow-x: auto;">
            <h2 style="margin-bottom: 15px;">Seating Chart (Aisle)</h2>
            <table class="seating-chart" style="width: 100%;">
                <colgroup>
                    <col style="width: 25%;">
                    <col style="width: 25%;">
                    <col style="width: 5%;"> 
                    <col style="width: 25%;">
                    <col style="width: 25%;">
                </colgroup>
                {% for row_index in range(SEAT_ROWS) %}
                <tr>
                    {% for col_index in range(SEAT_COLS) %}
                    {% set reservation_data = seat_map[row_index][col_index] %}
                    {% set seat_row = row_index + 1 %}
                    {% set seat_col = col_index + 1 %}
                    
                    {# The FIX: This line is correct only if you register 'chr' in Python #}
                    {% set seat_label = seat_row ~ chr(64 + seat_col) %}
                    
                    {% set status_class = 'reserved' if reservation_data else 'available' %}
                    
                    <td 
                        class="{{ status_class }}" 
                        style="
                            {% if col_index == 1 %} border-right: 5px solid transparent; {% endif %}
                            background-color: {{ '#dc2626' if reservation_data else 'rgba(34, 197, 94, 0.2)' }};
                            color: {{ 'white' if reservation_data else '#34d399' }};
                            font-weight: bold;
                        "
                        title="{{ reservation_data.name if reservation_data else 'Available' }}"
                    >
                        {{ seat_label }}
                    </td>
                    {% if col_index == 1 %}
                        <td style="background: none; border: none; padding: 5px;"></td>
                    {% endif %}
                    {% endfor %}
                </tr>
                {% endfor %}
            </table>
        </div>
        <div class="dashboard-section">
            <h2 style="margin-bottom: 10px;">Reservations ({{ reservations | length }})</h2>
            <ul class="reservation-list" style="max-height: 400px; overflow-y: auto;">
                {% for r in reservations %}
                <li style="justify-content: space-between; align-items: center; gap: 10px;">
                    <span style="flex-grow: 1; text-align: left;">
                        {{ r.name }} - **{{ r.seat }}** ({{ r.code }}) - <span style="color: #34d399;">${{ "%.2f"|format(r.price) }}</span>
                    </span>
                    <form action="{{ url_for('main.delete_reservation_route', reservation_id=r.id) }}" method="POST" style="display:inline; margin-left: auto;">
                        <button type="submit" 
                                onclick="return confirm('Are you sure you want to delete the reservation for {{ r.name }} ({{ r.seat }})?');"
                                class="menu-btn secondary" 
                                style="padding: 6px 10px; font-size: 0.8rem; background-color: #ef4444; border: none;">
                            Delete
                        </button>
                    </form>
                </li>
                {% else %}
                <li style="justify-content: center; opacity: 0.7;">No reservations made yet.</li>
                {% endfor %}
            </ul>
        </div>
        <div class="dashboard-section back-button-container">
            <a href="{{ url_for('main.main_menu') }}" class="menu-btn secondary">â¬… Back to Main Menu</a>
        </div>
    </div>
</div>
{% endblock %}